name: Process Ubuntu Mini ISO

on:
  push:
    branches:
      - master
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC

jobs:
  process-iso:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y xorriso cpio xz-utils build-essential gcc make meson ninja-build libjson-c-dev cmake libcmocka-dev ctorrent transmission-cli genisoimage syslinux-utils

      - name: Clone and build mini-iso-tools with patch
        run: |
          git clone -b nbxyz-mods https://github.com/netbootxyz/mini-iso-tools build/mini-iso-tools
          cd build/mini-iso-tools
          #cp ../../patches/json.c json.c
          meson setup build
          sudo ninja -C build
          sudo ninja -C build install

      - name: Download latest ISO
        run: |
          wget https://cdimage.ubuntu.com/ubuntu-mini-iso/daily-live/current/questing-mini-iso-amd64.iso

      - name: Extract VMlinuz and initrd
        run: |
          isoinfo -x /casper/vmlinuz -R -i questing-mini-iso-amd64.iso > vmlinuz
          isoinfo -x /casper/initrd -R -i questing-mini-iso-amd64.iso > initrd

      - name: Unpack initrd
        run: |
          mkdir -p initrd-unpack
          mv initrd initrd.orig
          cd initrd-unpack
          unmkinitramfs ../initrd.orig .

      - name: Apply patches and copy binary
        run: |
          mkdir -p initrd-unpack/main/tmp/mini-iso-menu/
          cp patches/iso-menu-session initrd-unpack/main/usr/lib/mini-iso-tools/
          cp /usr/lib/mini-iso-tools/iso-chooser-menu initrd-unpack/main/usr/lib/mini-iso-tools/
          cp build/mini-iso-tools/scripts/30mini-iso-menu initrd-unpack/main/scripts/casper-premount/30mini-iso-menu
          wget https://releases.ubuntu.com/streams/v1/com.ubuntu.releases:ubuntu-server.json -O initrd-unpack/main/tmp/mini-iso-menu/ubuntu-server.json
          wget https://releases.ubuntu.com/streams/v1/com.ubuntu.releases:ubuntu.json -O initrd-unpack/main/tmp/mini-iso-menu/ubuntu.json

      - name: Generate json files
        run: |
          python3 scripts/generate_iso_json.py --output-dir initrd-unpack/main/tmp/mini-iso-menu/

      - name: Repack initrd
        run: |
          cd initrd-unpack

          # Pack early directories if they exist
          if [ -d "early" ]; then
            cd early
            find . -print0 | cpio --null --create --format=newc > ../../initrd
            cd ..
          fi

          if [ -d "early2" ]; then
            cd early2
            find . -print0 | cpio --null --create --format=newc >> ../../initrd
            cd ..
          fi

          if [ -d "early3" ]; then
            cd early3
            find . -print0 | cpio --null --create --format=newc >> ../../initrd
            cd ..
          fi

          # Pack main directory (compressed)
          cd main
          find . | cpio --create --format=newc | xz --format=lzma >> ../../initrd

      - name: Generate json files
        run: |
          python3 scripts/generate_iso_json.py --output-dir output/

      - name: Extract ISO contents
        run: |
          mkdir iso-extract
          xorriso -osirrox on -indev questing-mini-iso-amd64.iso -extract / iso-extract/

      - name: Replace initrd and vmlinuz in ISO
        run: |
          # Replace the initrd and vmlinuz with our modified versions
          cp vmlinuz iso-extract/casper/vmlinuz
          cp initrd iso-extract/casper/initrd

          # Update file sizes in md5sum.txt if it exists
          if [ -f iso-extract/md5sum.txt ]; then
            # Remove old checksums for casper files
            grep -v "casper/vmlinuz\|casper/initrd" iso-extract/md5sum.txt > iso-extract/md5sum.txt.new || true
            # Add new checksums
            cd iso-extract
            md5sum casper/vmlinuz casper/initrd >> md5sum.txt.new
            mv md5sum.txt.new md5sum.txt
            cd ..
          fi

      - name: Inspect original ISO boot structure
        run: |
          echo "=== Inspecting ISO structure ==="
          isoinfo -d -i questing-mini-iso-amd64.iso
          echo ""
          echo "=== Looking for boot files ==="
          find iso-extract -type f -name "*.bin" -o -name "efi.img" -o -name "bios.img" | head -20
          echo ""
          echo "=== Checking boot directory ==="
          ls -la iso-extract/boot/ || echo "No /boot directory"
          echo ""
          echo "=== Checking for grub ==="
          find iso-extract -type d -name "grub*" | head -10

      - name: Repackage ISO
        run: |
          # Get ISO label from original ISO
          ISO_LABEL=$(isoinfo -d -i questing-mini-iso-amd64.iso | grep "Volume id:" | cut -d' ' -f3- | tr -d ' ')
          echo "ISO Label: $ISO_LABEL"

          # Find actual boot files
          if [ -f "iso-extract/boot/grub/bios.img" ]; then
            BIOS_IMG="boot/grub/bios.img"
            echo "Found BIOS boot image: $BIOS_IMG"
          elif [ -f "iso-extract/isolinux/isolinux.bin" ]; then
            BIOS_IMG="isolinux/isolinux.bin"
            echo "Found isolinux boot image: $BIOS_IMG"
          else
            echo "Warning: No BIOS boot image found, ISO may not be BIOS bootable"
            BIOS_IMG=""
          fi

          if [ -f "iso-extract/boot/grub/efi.img" ]; then
            EFI_IMG="boot/grub/efi.img"
            echo "Found EFI boot image: $EFI_IMG"
          elif [ -f "iso-extract/efi/boot/bootx64.efi" ]; then
            EFI_IMG="efi/boot/bootx64.efi"
            echo "Found EFI boot image: $EFI_IMG"
          else
            echo "Warning: No EFI boot image found"
            EFI_IMG=""
          fi

          # Build xorriso command dynamically
          XORRISO_CMD="xorriso -as mkisofs -r -V \"$ISO_LABEL\" -o ubuntu-netbootxyz-mini.iso -J -joliet-long"

          # Add BIOS boot if available
          if [ -n "$BIOS_IMG" ]; then
            if [[ "$BIOS_IMG" == *"isolinux"* ]]; then
              XORRISO_CMD="$XORRISO_CMD -b $BIOS_IMG -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table"
            else
              XORRISO_CMD="$XORRISO_CMD -b $BIOS_IMG -no-emul-boot -boot-load-size 4"
            fi
          fi

          # Add EFI boot if available
          if [ -n "$EFI_IMG" ]; then
            XORRISO_CMD="$XORRISO_CMD -eltorito-alt-boot -e $EFI_IMG -no-emul-boot -isohybrid-gpt-basdat"
          fi

          # Add source directory
          XORRISO_CMD="$XORRISO_CMD iso-extract/"

          echo "Running: $XORRISO_CMD"
          eval $XORRISO_CMD

          # Make ISO bootable on BIOS and UEFI (if supported)
          if [ -n "$EFI_IMG" ]; then
            isohybrid --uefi ubuntu-netbootxyz-mini.iso 2>/dev/null || echo "isohybrid failed or not needed"
          fi

          echo "ISO repackaged successfully"
          ls -lh ubuntu-netbootxyz-mini.iso

      - name: Generate checksums
        run: |
          sha256sum ubuntu-netbootxyz-mini.iso > ubuntu-netbootxyz-mini.iso.sha256
          md5sum ubuntu-netbootxyz-mini.iso > ubuntu-netbootxyz-mini.iso.md5
          sha256sum vmlinuz > vmlinuz.sha256
          sha256sum initrd > initrd.sha256

      - name: Release Files
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          draft: true
          files: |
            ubuntu-netbootxyz-mini.iso
            ubuntu-netbootxyz-mini.iso.sha256
            ubuntu-netbootxyz-mini.iso.md5
            vmlinuz
            vmlinuz.sha256
            initrd
            initrd.sha256
