name: Process Ubuntu Mini ISO

on:
  push:
    branches:
      - master
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC

jobs:
  process-iso:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y xorriso cpio xz-utils build-essential gcc make meson ninja-build libjson-c-dev cmake libcmocka-dev ctorrent transmission-cli genisoimage syslinux-utils

      - name: Clone and build mini-iso-tools with patch
        run: |
          git clone -b nbxyz-mods https://github.com/netbootxyz/mini-iso-tools build/mini-iso-tools
          cd build/mini-iso-tools
          #cp ../../patches/json.c json.c
          meson setup build
          sudo ninja -C build
          sudo ninja -C build install

      - name: Download latest ISO
        run: |
          wget https://cdimage.ubuntu.com/ubuntu-mini-iso/daily-live/current/resolute-mini-iso-amd64.iso

      - name: Extract VMlinuz and initrd
        run: |
          isoinfo -x /casper/vmlinuz -R -i questing-mini-iso-amd64.iso > vmlinuz
          isoinfo -x /casper/initrd -R -i questing-mini-iso-amd64.iso > initrd

      - name: Unpack initrd
        run: |
          mkdir -p initrd-unpack
          mv initrd initrd.orig
          cd initrd-unpack
          unmkinitramfs ../initrd.orig .

      - name: Apply patches and copy binary
        run: |
          mkdir -p initrd-unpack/main/tmp/mini-iso-menu/
          cp patches/iso-menu-session initrd-unpack/main/usr/lib/mini-iso-tools/
          cp /usr/lib/mini-iso-tools/iso-chooser-menu initrd-unpack/main/usr/lib/mini-iso-tools/
          cp build/mini-iso-tools/scripts/30mini-iso-menu initrd-unpack/main/scripts/casper-premount/30mini-iso-menu
          wget https://releases.ubuntu.com/streams/v1/com.ubuntu.releases:ubuntu-server.json -O initrd-unpack/main/tmp/mini-iso-menu/ubuntu-server.json
          wget https://releases.ubuntu.com/streams/v1/com.ubuntu.releases:ubuntu.json -O initrd-unpack/main/tmp/mini-iso-menu/ubuntu.json

      - name: Generate json files
        run: |
          python3 scripts/generate_iso_json.py --output-dir initrd-unpack/main/tmp/mini-iso-menu/

      - name: Repack initrd
        run: |
          cd initrd-unpack

          # Pack early directories if they exist
          if [ -d "early" ]; then
            cd early
            find . -print0 | cpio --null --create --format=newc > ../../initrd
            cd ..
          fi

          if [ -d "early2" ]; then
            cd early2
            find . -print0 | cpio --null --create --format=newc >> ../../initrd
            cd ..
          fi

          if [ -d "early3" ]; then
            cd early3
            find . -print0 | cpio --null --create --format=newc >> ../../initrd
            cd ..
          fi

          # Pack main directory (compressed)
          cd main
          find . | cpio --create --format=newc | xz --format=lzma >> ../../initrd

      - name: Generate json files
        run: |
          python3 scripts/generate_iso_json.py --output-dir output/

      - name: Extract ISO contents
        run: |
          mkdir iso-extract
          xorriso -osirrox on -indev questing-mini-iso-amd64.iso -extract / iso-extract/

      - name: Replace initrd and vmlinuz in ISO
        run: |
          # Replace the initrd and vmlinuz with our modified versions
          cp vmlinuz iso-extract/casper/vmlinuz
          cp initrd iso-extract/casper/initrd

          # Update file sizes in md5sum.txt if it exists
          if [ -f iso-extract/md5sum.txt ]; then
            # Remove old checksums for casper files
            grep -v "casper/vmlinuz\|casper/initrd" iso-extract/md5sum.txt > iso-extract/md5sum.txt.new || true
            # Add new checksums
            cd iso-extract
            md5sum casper/vmlinuz casper/initrd >> md5sum.txt.new
            mv md5sum.txt.new md5sum.txt
            cd ..
          fi

      - name: Repackage ISO with boot image cloning
        run: |
          echo "=== Repackaging ISO with original boot structure ==="

          # Use xorriso to extract boot image from original ISO and clone it
          # This preserves the exact boot configuration without needing to know the structure
          xorriso -indev questing-mini-iso-amd64.iso \
            -outdev ubuntu-netbootxyz-mini.iso \
            -boot_image any replay \
            -map iso-extract / \
            -end

          echo "ISO repackaged successfully with cloned boot image"
          ls -lh ubuntu-netbootxyz-mini.iso

          echo ""
          echo "=== Verifying new ISO boot configuration ==="
          isoinfo -d -i ubuntu-netbootxyz-mini.iso | grep -E "El Torito|boot"

      - name: Generate checksums
        run: |
          sha256sum ubuntu-netbootxyz-mini.iso > ubuntu-netbootxyz-mini.iso.sha256
          md5sum ubuntu-netbootxyz-mini.iso > ubuntu-netbootxyz-mini.iso.md5
          sha256sum vmlinuz > vmlinuz.sha256
          sha256sum initrd > initrd.sha256

      - name: Release Files
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ubuntu-netbootxyz-mini.iso
            ubuntu-netbootxyz-mini.iso.sha256
            ubuntu-netbootxyz-mini.iso.md5
            vmlinuz
            vmlinuz.sha256
            initrd
            initrd.sha256
